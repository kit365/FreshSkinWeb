<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Th√¥ng b√°o</title>
    <script>
        let socket;

        function connectWebSocket() {
            socket = new WebSocket("ws://localhost:8080/ws/notify");

            socket.onmessage = function(event) {
                let data = JSON.parse(event.data);
                updateNotificationUI(data);
            };

            socket.onclose = function() {
                setTimeout(connectWebSocket, 3000); // T·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i n·∫øu m·∫•t k·∫øt n·ªëi
            };
        }

        function updateNotificationUI(data) {
            let countElement = document.getElementById("notification-count");
            let panelNotifications = document.getElementById("notifications");

            // C·∫≠p nh·∫≠t s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc
            countElement.innerText = data.unreadCount;
            countElement.style.display = data.unreadCount > 0 ? "flex" : "none";

            // Th√™m th√¥ng b√°o v√†o khu v·ª±c th√¥ng b√°o
            let item = document.createElement("div");
            item.className = "notification-item unread";
            item.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${data.message}</span>
                    <span class="notification-date">${new Date(data.time).toLocaleString()}</span>
                </div>
                <div class="notification-actions">
                   <a href="https://project-swp391-n9j6.onrender.com/home/${data.slugProduct}" onclick="changeStatus('${data.id}');">Xem s·∫£n ph·∫©m</a>
                    <button onclick="deleteNotification('${data.id}')">X√≥a</button>
                </div>
            `;

            panelNotifications.prepend(item); // Th√™m m·ªõi v√†o ƒë·∫ßu danh s√°ch

            // Ki·ªÉm tra n·∫øu c√≥ nhi·ªÅu h∆°n 6 th√¥ng b√°o
            if (panelNotifications.children.length > 6) {
                document.getElementById("see-more").style.display = "block"; // Hi·ªán n√∫t "Xem th√™m"
            }
        }

        function toggleNotifications() {
            let panel = document.getElementById("notification-panel");
            panel.classList.toggle("show");

            if (panel.classList.contains("show")) {
                fetchNotifications(); // G·ªçi API khi m·ªü panel
            }
        }

        function fetchNotifications() {
            fetch('/admin/notify/show')
                .then(response => response.json())
                .then(data => {
                    let panelNotifications = document.getElementById("notifications");
                    panelNotifications.innerHTML = ""; // X√≥a th√¥ng b√°o c≈©

                    data.forEach(notification => {
                        let item = document.createElement("div");
                        item.className = "notification-item " + (notification.read ? "" : "unread");
                        item.innerHTML = `
                            <div class="notification-content">
                                <span class="notification-message">${notification.message}</span>
                                <span class="notification-date">${new Date(notification.time).toLocaleString()}</span>
                            </div>
                            <div class="notification-actions">
                                <a href="${notification.productLink}" onclick="changeStatus('${notification.id}');">Xem s·∫£n ph·∫©m</a>
                                <button onclick="deleteNotification('${notification.id}')">X√≥a</button>
                            </div>
                        `;

                        panelNotifications.appendChild(item); // Th√™m th√¥ng b√°o v√†o danh s√°ch
                    });

                    // C·∫≠p nh·∫≠t s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc
                    updateNotificationCount(data);

                    // Ki·ªÉm tra n·∫øu c√≥ nhi·ªÅu h∆°n 6 th√¥ng b√°o
                    if (panelNotifications.children.length > 6) {
                        document.getElementById("see-more").style.display = "block"; // Hi·ªán n√∫t "Xem th√™m"
                    } else {
                        document.getElementById("see-more").style.display = "none"; // ·∫®n n√∫t "Xem th√™m"
                    }
                });
        }

        function updateNotificationCount(notifications) {
            let unreadCount = notifications.filter(n => !n.read).length;
            let countElement = document.getElementById("notification-count");
            countElement.innerText = unreadCount;
            countElement.style.display = unreadCount > 0 ? "flex" : "none";
        }

        function seeMoreNotifications() {
            let panel = document.getElementById("notifications");
            panel.style.maxHeight = "none"; // B·ªè gi·ªõi h·∫°n chi·ªÅu cao ƒë·ªÉ hi·ªán t·∫•t c·∫£ th√¥ng b√°o
            document.getElementById("see-more").style.display = "none"; // ·∫®n n√∫t "Xem th√™m"
        }

        function changeStatus(id) {
            fetch(`/admin/notify/change-status/${id}`, { method: 'PATCH' }) // G·ªçi API ƒë·ªÉ thay ƒë·ªïi tr·∫°ng th√°i
                .then(response => {
                    if (response.ok) {
                        // X·ª≠ l√Ω sau khi thay ƒë·ªïi tr·∫°ng th√°i th√†nh c√¥ng (n·∫øu c·∫ßn)
                    }
                });
        }

        function deleteNotification(id) {
            fetch(`/admin/notify/delete/${id}`, { method: 'DELETE' }) // G·ªçi API ƒë·ªÉ x√≥a th√¥ng b√°o
                .then(response => {
                    if (response.ok) {
                        // T√¨m ph·∫ßn t·ª≠ th√¥ng b√°o trong DOM v√† x√≥a n√≥
                        let notificationItem = document.querySelector(`#notification-item-${id}`);
                        if (notificationItem) {
                            notificationItem.remove(); // X√≥a ph·∫ßn t·ª≠ th√¥ng b√°o kh·ªèi DOM
                        }

                        // C·∫≠p nh·∫≠t l·∫°i s·ªë l∆∞·ª£ng th√¥ng b√°o ch∆∞a ƒë·ªçc
                        updateNotificationCount(getCurrentNotifications());
                    }
                });
        }

        function deleteAllNotifications() {
            fetch('/admin/notify/delete-all', { method: 'DELETE' }) // G·ªçi API ƒë·ªÉ x√≥a t·∫•t c·∫£ th√¥ng b√°o
                .then(response => {
                    if (response.ok) {
                        fetchNotifications(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch th√¥ng b√°o
                    }
                });
        }

        window.onload = connectWebSocket;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5; /* M√†u n·ªÅn nh·∫π nh√†ng */
            color: #333;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
        }

        .notification-icon {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background: red;
            color: white;
            font-size: 12px;
            font-weight: bold;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        }

        .notification-panel {
            position: fixed;
            top: 50px;
            right: 10px;
            width: 400px; /* Chi·ªÅu r·ªông t·ªëi ∆∞u cho giao di·ªán */
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: none;
            padding: 15px;
            z-index: 1000; /* ƒê·∫£m b·∫£o panel n·∫±m tr√™n c√°c ph·∫ßn t·ª≠ kh√°c */
            max-height: 400px; /* Chi·ªÅu cao t·ªëi ƒëa cho panel */
            overflow-y: auto; /* Cho ph√©p cu·ªôn d·ªçc */
        }

        .notification-panel.show {
            display: block;
        }

        .notification-item {
            padding: 15px;
            border-radius: 8px; /* Bo tr√≤n g√≥c */
            margin-bottom: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c th√¥ng b√°o */
            background: #f9f9f9; /* N·ªÅn th√¥ng b√°o */
            display: flex; /* CƒÉn ch·ªânh c√°c ph·∫ßn t·ª≠ b√™n trong */
            flex-direction: column; /* ƒê·∫∑t c√°c ph·∫ßn t·ª≠ theo chi·ªÅu d·ªçc */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Hi·ªáu ·ª©ng b√≥ng */
        }

        .notification-item.unread {
            border-left: 4px solid #007bff; /* ƒê∆∞·ªùng vi·ªÅn b√™n tr√°i cho th√¥ng b√°o ch∆∞a ƒë·ªçc */
            background: #e9f5ff; /* N·ªÅn kh√°c cho th√¥ng b√°o ch∆∞a ƒë·ªçc */
        }

        .notification-content {
            display: flex;
            justify-content: space-between; /* CƒÉn ch·ªânh n·ªôi dung */
            align-items: center; /* CƒÉn gi·ªØa n·ªôi dung */
            margin-bottom: 8px; /* Kho·∫£ng c√°ch gi·ªØa n·ªôi dung v√† ng√†y th√°ng */
        }

        .notification-message {
            font-weight: bold;
            flex: 1;
        }

        .notification-date {
            font-size: 12px;
            color: gray;
            margin-left: 10px; /* Kho·∫£ng c√°ch gi·ªØa tin nh·∫Øn v√† ng√†y th√°ng */
        }

        .notification-actions {
            display: flex;
            justify-content: flex-end; /* CƒÉn ch·ªânh c√°c n√∫t */
            gap: 5px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
        }

        .notification-actions a {
            text-decoration: none;
            color: white;
            background: #007bff; /* M√†u n·ªÅn n√∫t */
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .notification-actions a:hover {
            background: #0056b3; /* Hi·ªáu ·ª©ng hover */
        }

        .notification-actions button {
            border: none;
            background: #dc3545; /* M√†u n·ªÅn n√∫t x√≥a */
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .notification-actions button:hover {
            background: #c82333; /* Hi·ªáu ·ª©ng hover */
        }

        .see-more {
            display: none; /* ·∫®n n√∫t "Xem th√™m" m·∫∑c ƒë·ªãnh */
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            color: blue;
            font-weight: bold;
        }

        .delete-all {
            margin-top: 10px;
            text-align: center;
            cursor: pointer;
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="notification-container" onclick="toggleNotifications();">
    <div class="notification-icon">
        üîî
        <span id="notification-count" class="notification-badge">0</span>
    </div>
</div>

<div id="notification-panel" class="notification-panel">
    <div id="notifications"></div> <!-- T·∫•t c·∫£ th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
    <div id="see-more" class="see-more" onclick="seeMoreNotifications();">Xem th√™m</div> <!-- N√∫t "Xem th√™m" -->
    <div class="delete-all" onclick="deleteAllNotifications();">X√≥a t·∫•t c·∫£</div> <!-- N√∫t "X√≥a t·∫•t c·∫£" -->
</div>
</body>
</html>